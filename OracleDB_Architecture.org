* OracleDB Architecture
** 全体構成
*** Oracleソフトウェア
- ホスト・コンピュータ上にインストール
*** Oracleデータベース
- ディスク上の物理ファイルの集合
- 内容
  - データファイル
  - 制御ファイル
  - REDOログファイル
*** Oracleインスタンス
- メモリ構造:SGA
- プロセス構造:バックグラウンドプロセス
*** サーバープロセス
- サーバープロセス
- メモリー、一次記憶域
  PGAを利用
*** Oracle Net
- Oracle Net
- Oracle Netリスナー
** Process
*** About
- Oracleでは複数のプロセスが実行されている。
  またWindows上では、複数プロセスでなくマルチスレッドによる動作となる。
  
- MTSと呼ばれる構成にしない限り、Oracleクライアント1つに対して、サーバープロセスが1つ対応する。

*** User Process(Client)
- SQL文を発行するツール、あるいはユーティリティ。
  SQL*Plus, Oracle Enterprise Manager, SQL Developerなど。
- 接続するデータベースの情報を設定ファイルに記述し、リスナーを経由してデータベースに接続。
  - TNSNAMES.ORAのorcl=(...)など。データベースの接続情報に名前を付けて保存している。
*** Listener Process
- Oracle Databseへの接続リクエストを転送
  リスナープロセスを経由してサーバープロセスに接続する
*** Server Process
- ユーザプロセスから受け取ったSQL文を、実際にOracleインスタンスと対話させ実行するプロセス。
  原則的には、SQLの結果を返すために必要なことを行う。
- ユーザ毎に起動され、リクエストを処理する。
  リスナープロセスを経由して、ユーザープロセスと接続する。
*** Background Process
- SGAとデータベースファイルとの同期や、整合性の保持などの役割。
  原則的には、SQLの結果を返すために必要なこと以外を行う。
- https://docs.oracle.com/cd/E60665_01/db112/REFRN/bgprocesses.htm
**** PMON プロセス・モニター
- サーバ・プロセスの監視を行い、ユーザ・プロセス障害時にクリーンナップを行う（ロックの解放、ロールバックなど）
- ora_pmon_XXXXXX(SID)
  ピーモン。プロセスを監視し、プロセス障害を見つけた場合に掃除する。
**** SMON システム・モニター
- インスタンス障害後、再起動の際に自動的にインスタンス・リカバリを行う
**** DBWn データベース・ライター
- データベース・バッファ・キャッシュ上で更新されたデータを定期的にデータ・ファイルに書き込む。
- ora_dbwX(0や1)_XXXXXX(SID)
  データベースライター。データをディスクに書く。
**** CKPT チェックポイント
- チェックポイント発生時に制御ファイルやデータ・ファイルのヘッダを更新し、同期をとる。
**** LGWR ログ・ライター
- REDOログ・バッファ上のREDOログ・エントリを定期的にREDOログ・ファイルに書き込む（COMMIT時など）
- ora_lgwr_XXXXXX(SID)
  ログライター。ログをディスクに書く。
**** ARCn アーカイバ・プロセス
- ora_arcX(0や1)_XXXXXX(SID)
  アーカイバ。ログデータをアーカイブ（長期保存のため別ファイルとして保存）する。
**** MMAN メモリー・マネージャ・プロセス
- Memory Manager
- インスタンスのメモリー・コンポーネントのサイズ変更を実行する。
**** MMON 管理性モニタープロセス
- Manageability Monitor
- AWRのスナップショットの取得、Automatic Database Diagnostic Monitor分析の実行など、管理性に関するタスクを実行する。
** Memory
- [[https://docs.oracle.com/cd/E16338_01/server.112/b56306/memory.htm#i8451][14 メモリー・アーキテクチャ - Oracle® Database概要 11gリリース2 (11.2)]]
*** Cache
- どのプロセスからも見ることができるメモリをキャッシュとしている。
  OSの共有メモリの機能を使っている。

**** Buffer Cache
- 書き込み用データもキャッシュに保存される。
  DBWRが定期的に変更済みデータをディスクに保存している。
  
- フルスキャンデータはキャッシュヒットする可能性も少なく、他のデータも追い出してしまうため、
  Oracleでは大きな表であればバッファキャッシュに長時間留めないようにする。
  そのため、一般にフルスキャンしたデータはバッファキャッシュに載っていない、と考える。

*** PGA
- Program Global Area
  共有でないメモリの一部。サーバー・プロセス（およびバックグラウンドプロセス）に対する専用の作業領域。
  ソート処理やハッシュ結合などで使われる。
- サーバプロセスやバックグラウンドプロセスなど、プロセスごとに確保される領域。
**** 内容
- セッション情報 (UGA?)
  セッションに対するユーザの権限に関する情報
- カーソル状態
  セッションで使用している様々なカーソルの処理段階を示す
- スタック空間
  セッション変数が入っている空間
- ソート領域
  データのソートに使用
**** 不足した場合の問題
- PGAが不足した場合、メモリ内でソート処理ができずディスクソートが発生、
  ソート、結合などの処理速度が大きく低下。
*** SGA
- System Global Area システムグローバル領域
  共有領域。
  便利だが競合が起こるため、ロックによる排他制御が必要で、性能トラブル等が起きやすい原因となっている。
- Command
  - select * from v$sga;
  - show sga
**** 共有プール
- SQLキャッシュとしての役割。実行するSQLと同じSQLが共有プール上にある場合、解析をスキップできる。
  SQL文の解析情報、実行計画、データディクショナリのデータが格納される。
- 一度実行されたSQL文の解析に使うデータや実行計画、ユーザかんで共有できる様々な構造をキャッシュする領域
***** 不足した場合
- 一度読み込んだデータ・ディクショナリ情報や一度立てた実行計画がフラッシュされ、
  何度もディクショナリ情報をディスクから読んだり、実行計画を使いまわせず再解析が必要となったりする。
**** データベース・バッファ・キャッシュ
- データキャッシュとしての役割。
  SQL文の実行に必要なデータがデータベース・バッファ・キャッシュにあれば、メモリアクセス、なければディスクアクセスとなる。
  データブロック（表、索引など）が格納される。
***** 不足した場合
- 一度キャッシュしたブロックをファイルに書き出し、再アクセス時にディスクから読み込むこととなる。
**** REDOログ・バッファ
- ディスク(REDOログ・ファイル）に書き込むまでREDO情報をキャッシュ（インスタンス・リカバリに仕様）する
- データベースに対して行われたあらゆる更新履歴を持つ。これを「REDOログエントリ（変更履歴）」と呼ぶ。
  障害時にリカバリとして使われるデータ。
  REDOログが格納される。
- COMMITやメモリが一杯になったタイミングでREDOログ・ファイルに内容を反映。ログライターにより行われる。
**** Javaプール
- オプション
- データベース内でJavaを実行する場合に使用するオプション領域。
  JVM内のすべてのセッション固有のJavaコード、データを含む。
**** ラージ・プール
- オプション
- 特定の大きなプロセス（Oracleバックアップ、リカバリ操作、I/Oサーバー・プロセスなど）が使用できるオプション領域
**** Streamsプール
*** UGA : User Global Area
- ユーザーセッションに関連付けられたメモリー。セッションメモリー。
  ログオン情報やデータベース・セッションに必要な情報などのセッション変数に割り当てられるメモリー。
- 共有サーバ接続では結果の共有のためSGA（ラージプール）上にUGAが、専用サーバ接続では共有が不要のためPGA上にUGAが存在するらしい。
  また、Oracleは基本的にはPGAに多くのデータは置かれるようにできているとのこと。
  https://www.freelists.org/post/oracle-l/UGA-and-PGA-basic-question,1
  http://www.atmarkit.co.jp/ait/articles/0706/20/news129.html
**** 内容
- Session Variabels
- OLAP Pool
*** Software Code Area

*** Management 管理
- 11g:
  合計メモリサイズを指定するとSGAの各コンポーネントとPGAに必要に応じて最適なメモリが割り当てられる（自動メモリ管理）。
- 10gまで:
  SGAとPGAにそれぞれメモリ割り当てを設定。SGA内では最適メモリ割り当てがなされる
- 手動管理:
  SGAの各メモリコンポーネントおよびPGAに、それぞれメモリ・サイズを設定。
**** メモリ管理自動化の変遷
- 11g:
  - SGA + PGA / memory_target 合計メモリ・サイズ
- 10g:
  - SGA / sga_target 共有メモリ・サイズ
  - PGA / pga_aggergate_target
- 9i:
  - SGA相当
    - バッファキャッシュ db_cache_size
    - 共有プール shared_pool_size
    - Javaプール java_pool_size
    - ラージプール large_pool_size
    - REDOログバッファ log_buffer_size
  - PGA / pga_aggregate_target
- 8i:
  - SGA相当
    - バッファキャッシュ db_cache_size
    - 共有プール shared_pool_size
    - Javaプール java_pool_size
    - ラージプール large_pool_size
    - REDOログバッファ log_buffer_size
  - PGA相当
    - sort_area_size
    - hash_area_size
    - bitmap_merge_area_size
    - create_bitmap_area_size
** Files
- Oracleデータベース部分
*** データファイル Data File
- ユーザーが利用するデータ（表など）を格納
- データ格納先のファイルを「表領域」単位で管理
  - 表領域は表の論理的な格納先。ファイルの場所やサイズを意識せず柔軟に管理可能に。
  - データは物理的にデータ・ファイルに格納される
  - 表領域は1つ以上のデータ・ファイルから構成される
- データベースは、目的ごとに複数の表領域を作成
**** データ・ディクショナリ
- データベース内のオブジェクト定義やユーザ情報などの管理するための内部表。
  実行前に解析を行う。
*** 制御ファイル Control File
- データベースの制御情報・構造に関する情報を格納
- 内容
  - データベース情報
    データベース名、識別子
  - データ・ファイル情報
    表領域と対応するデータ・ファイルの名前と場所、現在の状態等
  - REDOログ・ファイル情報
    REDOログ・ファイル名前と場所、最新のREDOログファイルの情報、アーカイブ情報塔
  - その他
    チェックポイント情報（メモリ上の情報をいつ、どこまでファイルに反映したか等）
    バックアップ情報
**** 関連コマンド
- configure control file autobackup on;
  構成変更が行われる度に、制御ファイルの自動バックアップが取得される。

*** REDOログファイル REDO Log File
- データベースへの変更情報・履歴(DML,DDL等)を格納
- 雑記
  - 書き込みタイミング
    - COMMIT時
    - REDOログ・バッファが一杯になった時
    - データベース・ライターが書き込む時
    など
  - 障害時の復旧に使用
  - ファイルは循環運用される
*** その他
**** 初期化パラメータ・ファイル
- Oracleインスタンスの構成（メモリ、プロセスなど）を記述したファイル。
  起動時(NOMOUNTの時点、最初)に読み込まれる。
  $ORACLE_HOME/dbs配下に存在している。
  PFILEは"initSID.ora", SPFILEは"spfileSID.ora"

  制御ファイルのパスやアーカイブログなどのその他ファイルパス、各種パラメータが書かれている。
**** アーカイブ・ログ・ファイル
- 一杯になったREDOログ・ファイルのオフライン・コピー
  REDOログ・ファイルの変更履歴を永続的に格納し、リカバリに使用する場合に必要。
  - REDOログ・ファイルは循環運用されるため、古いものは上書きされる。
    昔のものをアーカイブして、復旧できるようにする。
  - ARCHIVELOGモードで稼働している場合に作成される。

***** 関連コマンド
- ARCHIVE LOG LIST
  アーカイブログのステータスを確認する
- SELECT LOG_MODE FROM V$DATABASE;
- ALTER DATABASE ARHCIVELOG;
  アーカイブログモードへ移行する
- ALETR DATABASE ARCHIVELOG MANUAL;
  手動アーカイブモードとなる
- ALTER DATABASE NOARCHIVELOG;
  ノーアーカイブログモードに変更
****** Obsolete
- ALTER SYSTEM ARCHIVE LOG {START|STOP};
  (10gで廃止)
**** アラート・ログ・ファイル
- 様々な情報
  - 内部エラー
  - データベースの起動と停止、表領域の追加、削除などの管理作業
  - 起動時の初期化パラメータ
**** トレース・ログ・ファイル
**** バックアップ・ファイル
*** 各種プログラム
- オラクルのプログラムは「oracle」という名前のファイルで、$ORACLE_HOME/binに存在。
  その他sqlplusなどのプログラムも同フォルダ上に存在している。
** Logical Storage
*** 表領域
**** 種類
***** 事前定義領域
****** SYSTEM表領域
- SYSTEMという表領域。データベース作成時に自動的に作成される。
  データベースのオープン中は常にオンラインになっている。
- 内部表（データディクショナリ）などを格納する

******* データ・ディクショナリ
- SYSTEM表領域にはデータ・ディクショナリ表が必ず含まれる。
  データファイル1に格納される。

******* PL/SQLプログラムユニット
- ストアドPL/SQLプログラム・ユニットのために格納されるデータは、すべてSYSTEM表領域にある。

****** SYSAUX表領域
- SYSTEM表領域の補助表領域。
  多数のデータベース・コンポーネントで、デフォルトのデータ格納場所としてSYSAUX表領域が使用される。
  そのため、データベースの作成時またはアップグレード時に必ずSYSAUX表領域が作成される。
  SYSTEM表領域に常駐しないデータベース・メタデータの集中格納場所となる。
- オプションの機能が使用するデータを格納する内部使用領域

****** USERS表領域
- ユーザー表用に用意されているデフォルト表領域
****** 一時表領域(TEMP)
- Oracle7.3より提供された表領域の種類。
  セッションの間のみ存続する一時データが格納される。
  中間ソート結果、一時表と一時索引、一時LOB、一時Bツリーを格納するために使用する。
  一時表領域が明示的に割り当てられていないユーザは、デフォルト一時表領域（新規インストールではTEMP）を使用する。
- ソートなどで一時的に使用するデータを置く。

****** UNDO表領域
- ロールバック情報の格納にのみ使用する特別な表領域。
- データの変更時、変更前データを置く
***** ローカル管理表領域
- 
  表領域によるエクステント管理。
  各データファイルのビットマップが保持され、ビットマップを使用して、使用済領域と空き領域が追跡される。
  Oracle8iより提供。デフォルト。
  EXTENT MANAGEMENT句にLOCALを指定する。

- Extent Management
  AUTOALLOCATE, UNIFORMが選択可能。
  AUTOALLOCATEがデフォルト。UNIFORMを指定して均一エクステントによる管理も可能。
  さまざまなサイズのオブジェクトが表領域に含まれ、異なるサイズの多数のエクステントが必要と予測される場合、AUTOALLOCATEを選択する。
  エクステントの数とサイズが正確に予測できる場合はUNIFORMを選択する。SIZEを指定しない場合はデフォルトで1MBとなる。

***** ディクショナリ管理表領域
- 
  データ・ディクショナリによる表領域管理。
  領域の使用率の追跡をSQLディクショナリ表に依存する従来の方法で管理する表領域。
- 
  10gからシステム領域を含みすべての領域に対してローカル表領域がデフォルトとなっている。
  システム表領域をローカル管理領域で作成するとディクショナリ管理表領域は作成できなくなるため、
  10g以降は通常のデータベース作成ではディクショナリ管理表領域は作成できない。

***** bigfile表領域
- 
  単一で非常に大きいデータファイル（最大40億ブロック）を持つ可能性がある表領域。
  従来のsmallfile表領域は複数のデータファイルを格納できるが、各データファイルは大きくない。

**** 備考
- 表の論理的な格納先
- 物理的には1つ以上のデータファイルに格納される
  
*** セグメント
*** エクステント
*** Oracleデータ・ブロック
**** PCTFREE
- 既存の行を更新する場合に備えて、空き領域として確保される割合の最小値。
  "20"と設定した場合、挿入に対して80%使用可能で、20%は更新のために保持される。
**** PCTUSED
- 新しい行をブロックに追加するときに、行データとオーバーヘッドに使用できるブロックの割合の最小値。
  PCTFREEで指定した限界値までブロックが満たされると、その割合がPCTUSEDの値を下回るまで、そのブロックを新しい行の挿入に使用できない。
**** Block
- 
  データを管理する単位。
  I/Oの単位やバッファキャッシュはブロック単位で管理されている。
  OSのブロックとは異なり、Oracle独自のブロック。
  
  ブロックサイズは2KB, 4KB, 8KB, 16KB, 32KBといったサイズから選べる。

***** 構造
- ブロックヘッダ
  管理用の領域。データの先頭部分に格納される。
- データ
  ブロックの後ろから順に格納する。
  DELETEにより空いた領域を詰めなおすことはしない。
  
** Optimizer
*** Cost Base
- 
  処理時間やI/O回数が最小になると考えられる処理を最上するアルゴリズム。
  コストとは、処理に必要と思われる時間、もしくはリソース使用量のこと。

**** Analyze
- 
  9i R2までは管理者が定期的、もしくは事前に行っておくことが推奨されていたが、
  10gからはOracleが自動的に行ってくれる。

- 統計情報
  - SQL文の情報
  - 表やインデックスの統計情報
  - パラメータの情報
  - システム統計情報
    - 1作業あたりにかかる時間の目安
    - oracle 10gからのデフォルト情報。
    - CPUのクロック、
*** Rule Base
- 
  10g以降はサポートしていない。

** Status
*** OPEN
- 稼働状態。
  データファイルのチェックなどが済み、実際に動作できる状態。
  
*** MOUNT
- コントロールファイルを読み込んだ状態。データファイルなどにアクセスできる状態。
  各種ファイルの場所は知っているが、この段階では実際に各種ファイルにアクセスしないため、
  読み込み先ファイルが存在しなかったり、問題のあるファイルであってもエラーは出ない。
- OPEN : データファイルのチェックなどをする
  alter database open
  データファイルを開いて簡単にチェックをしたり、一部のバックグラウンドプロセスを起動したりしている。

*** NOMOUNT
- バックグラウンドプロセスと共有メモリが存在する状態。インスタンスが起動した状態。
  パラメータファイルを読み込んだ状態（パラメータファイルは主要なDBファイルではない）。
- MOUNT : 制御ファイルを読み込む
  alter database mount
  初期化パラメータに記述されている制御ファイルのパスを使用して、制御ファイルを開いて中身を読む。
  REDOログファイルやデータファイルの位置を把握する。
  なお、場所を知るだけなのでファイルが無くてもこの時点ではエラーにならない。

*** SHUTDOWN
- 停止状態。
- NOMOUNT : パラメータを読み込み、バックグラウンドプロセスの起動や共有メモリを確保する
  startup (nomount)

** Link
- [[http://www.oracle.com/webfolder/technetwork/tutorials/obe/db/12c/r1/poster/OUTPUT_poster/poster.html][Oracle Database 12c: INTERACTIVE QUICK REFERENCE]]
- [[http://damir-vadas.blogspot.jp/2012/01/oracle-11g-architecture-interactive.html][Oracle Database 11g - Architecture Diagram]]

- [[http://www.oracle.com/technetwork/jp/ondemand/db-basic/0420-1330-oracle-architecture-366291-ja.pdf][今さら聞けない!?Oracle入門 ～アーキテクチャ編～]]
- [[http://onefact.jp/wp/2014/08/29/oracle%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3%E3%82%92%E3%81%A9%E3%81%AE%E3%82%88%E3%81%86%E3%81%AB%E7%90%86%E8%A7%A3%E3%81%99%E3%82%8B%E3%81%8B/][Oracleアーキテクチャをどのように理解するか - サイクル＆オラクル]]
- [[http://www.atmarkit.co.jp/ait/articles/1010/29/news127.html][Oracleデータベースアーキテクチャを復習する - 独学！ ORACLE MASTER Gold 11g講座（1） - @IT]]
- [[https://enterprisezine.jp/iti/detail/29][SQLの実行と排他制御からDBの内部動作を知る - DB Magazineスぺシャル]]
