# Regular Expression
## About
- 
  もともと正規言語を表すための手段として導入された。
  
- 
  grepなどでは、「マッチするか」「マッチしないか」のみ考慮される。
  「どれだけマッチしたか」は基本関係ない。
  他のものをはじくためにのみ、より強固な文字列によるマッチを検討する必要がある。

- 
  置換では、マッチの位置が重要となる。

## Type
### BRE
- basic regular expression

#### Meta Characters
##### 置換前
###### External Bracket
####### ^
- 
  head of the sentence

####### $
- 
  end of the sentence

####### .
- 
  a character

####### {...]
- 
  Match a word in the bracket.
  character class.

####### [^...]
- 
  Match other characters in the bracket

####### *
- 
  repeat over 0 times.

####### \{n\}
- 
  n times repeat

####### \{n,\}
- 
  more than n times repeat

####### \{m,n\}
- 
  over m and under n times repeat

####### \(...\)
- 
  
####### \n
####### \x
####### \\
###### Character ClassInternal Bracket
####### ^
####### -
####### [
####### ]
####### \x
####### \\
##### 置換後
###### \n
- n
###### &
###### \x
###### \\
#### Special Characters
- 
  when using as normal character, need to escape by \
  . [ \ * ^ $

### ERE
- extended regular expression、拡張正規表現

#### Meta Characters
##### 置換前
###### External Bracket
####### ^
####### $
####### .
####### [...]
####### [^...]
####### *
####### +
####### {n}
####### {n,}
####### {m,n}
####### ?
####### (...)
####### |
####### \x
####### \\
###### Internal Bracket
- BREとおなじ
##### 置換後
- BREとおなじ
#### Special Characters
- 
  when using as normal character, need to escape by \
  . [ \ ( ) * | ? { | ^ $

### EMACS Regular Expressions
- [[https://www.emacswiki.org/emacs/RegularExpression][Regular Expression - EmacsWiki]]

#### Command
- C-M-s
- C-M-r
- replace-regexp

### Perl Extention
#### Outsite of Character Class
##### \b
- 
  語の先頭と末尾にマッチする。
##### \d
- 
  [0-9]

##### \D
- 
  \d以外。[^0-9]

##### \n
- 
  改行
##### \r
- 
  復帰
##### \s
- 
  空白文字にマッチする。
  スペース、タブ、改行、復帰
##### \S
- 
  \s以外のすべての文字
##### \t
- 
  タブにマッチする

##### \w
- 
  
##### \W
- 
  \w以外。[^a-zA-Z0-9_]

#### parenthesis sequence
##### キャプチャしない
###### (?:...)
##### 先読み・後読み
- 
  パターンと一致する「位置」にマッチする。
  ex) (?=Jeffery)Jeffは、Jefferyが続く場合の"Jeff"のみにマッチ。Jeffersonにはマッチしない。
  
###### (?=pattern)
- 肯定的先読み
###### (?!pattern)
- 否定的先読み
###### (?<=pattern)
- 肯定的後読み
###### (?<!pattern)
- 否定的後読み
### Utility Regular Expression Type
- 
  |---------+---------------------------|
  | Utility | Type                      |
  |---------+---------------------------|
  | vi      | Basic                     |
  | sed     | Basic                     |
  | grep    | Basic                     |
  | csplit  | Basic                     |
  | dbx     | Basic                     |
  | dbxtool | Basic                     |
  | more    | Basic                     |
  | ed      | Basic                     |
  | expr    | Basic                     |
  | lex     | Basic                     |
  | pg      | Basic                     |
  | nl      | Basic                     |
  | awk     | Extended(Subset)          |
  | nawk    | Extended                  |
  | egrep   | Extended                  |
  | Emacs   | Emacs Regular Expressions |
  | Perl    | PERL Regular Expressions  |
  |---------+---------------------------|

## Match Mode
### 大文字と小文字を区別しないモード
- 
  - タイトル文字
  - ドイツのSSと小文字ß(Eszett)
  - ǰの大文字が存在せず結合文字のみ
  など

### フリーフォーマットモード
- 
  文字クラス外の空白はほとんど無視され、文字クラス内の空白だけが正規表現の一部として使われる。

### ドット全マッチモード（単一行モード）
- 
  改行を超えて（含めて）、.*が全体にマッチする

- 
  Perlが導入した際に単一行モード、としたが、^や$とは無関係のため、混乱の元となっている。
  .に制限がなく、改行を含めた任意の文字列にマッチする、という意味に過ぎない。

### 拡張行アンカーマッチモード（複数行モード）
- 
  ^と$がマッチする位置に影響を与える。
  文字列に改行が含まれている場合、文字列を実質的に複数の論理行として扱う。
  このモードを持つ場合、\Aと\Zもサポートすることが多く、このモードになっても通常の^と$のように改行を無視して先頭・末尾にのみマッチする。
  
  複数行モードは、^と$が何にマッチするかを変更するのみである。

### リテラルテキストモード
- 
  ほとんど、もしくはすべての正規表現メタ文字を認識しないモード。
  たとえば、[a-z]*が'[a-z]*'という文字列にマッチする。

## Meta Characters
- 良く使われるもの
### 文字
#### \a
- アラート。ASCIIの<BEL>
#### \b
- バックスペース
#### \e
- エスケープ文字
#### \f
- 改ページ
#### \n
- 改行
#### \r
- 復帰
#### \t
- 水平タブ
#### \v
- 垂直タブ
#### \num
- 8進エスケープ
  \015\012でCR/LFなど。
#### \xnum, \x{num}, \unum, \Unum
- 16進・Unicodeエスケープ
  \x0D\x0Aなど。
#### \cchar
- 制御文字
  \cHでバックスペース、\cJで改行など。

### 文字クラス
#### [a-z], [^a-z]
- 通常の文字クラス

#### . ドット
- ほぼすべての文字
  改行以外のすべての文字にマッチする場合が多い。
  
  否定文字クラスの[^"]などは改行にマッチするため、注意が必要。

#### \C
- 1バイト
  「1バイト」にマッチする。

#### \X
- 結合文字シーケンス
  「\P{M}\p{M}*」の略記法として、\Xをサポートしている。
  基底文字の後ろに任意の個数の結合文字が続いたもの。

#### 略記
##### \d
- 数字
##### \D
- 数字以外
##### \w
- 単語の一部とみなされる文字。
  [a-zA-Z0-9_]の場合が多い。
##### \W
- 単語の一部でない文字。
##### \s
- 空白文字。
  ASCIIのみでは[ \f\n\r\t\v]であることが多い
##### \S
- 空白文字以外
#### \p{Prop}, \P{Prop}
- Unicodeの特定のプロパティを持つ（持たない）文字にマッチ。

##### 一般プロパティ
- 
  |--------+-----------------+------|
  | クラス | 同義語          | 説明 |
  |--------+-----------------+------|
  | \p{L}  | \p{Letter}      |      |
  | \p{M}  | \p{Mark}        |      |
  | \p{Z}  | \p{Separator}   |      |
  | \p{S}  | \p{Symbol}      |      |
  | \p{N}  | \p{Number}      |      |
  | \p{P}  | \p{Punctuation} |      |
  | \p{C}  | \p{Other}       |      |
  |--------+-----------------+------|
  
###### サブプロパティ

##### スクリプト
- 
  \p{Hebrew}（ヘブライ文字）、\p{Thai}、\p{Latin}など。
  スペースや句読点などの共通文字は、どのスクリプトにも属さず残りすべてを含むIsCommonに属す。
  Inheritedは、付加される基底文字の書記系から継承された結合文字で構成される。

##### ブロック
- 
  コードポイントの範囲を示す。ただし、スクリプトよりも劣っている。
  
#### [[a-z]-[aeiou]]
- 単純な文字クラスの減算
  .NETには文字クラスの"減算"記法がある。
  
#### [[a-z]&&[^aeiou]]
- 文字クラス集合演算
  Java正規表現パッケージは、本格的な集合演算をサポートしている。

#### [:alpha:]
- POSIXブラケット表現
  文字クラスの中だけで有効なので、[a-z]は[[:lower:] ]となる。
##### [:alnum:]
- 英字と数字
##### [:alpha:]
- 英字
##### [:blank:]
- スペースとタブ
##### [:cntrl:]
- 制御文字
##### [:digit:]
- 数字
##### [:graph:]
- 空白以外の文字
##### [:lower:]
- 小文字の英字
##### [:print:]
‐ [:graph:]にスペースを含む。
##### [:punct:]
- 句読点
##### [:space:]
- 全ての空白文字
##### [:upper:]
- 大文字の英字
##### [:xdigit:]
- 16進表記で認められている数字

#### [[.span-ll.] ]
- 照合シーケンス
#### [[=n=] ]
#### シンタックスクラス
- \schar, \Schar
  Emacsでは\wや\sをサポートしないが、"シンタックスクラス"を参照する特別なシーケンスを持っている。
### ゼロ幅マッチ
#### ^, \A
#### $, \Z, \z
#### \G
- マッチの先頭、もしくは前のマッチの末尾
  /gで反復的な検索を行うときに便宜を図る機能で、前回のマッチの末尾にマッチすることになっている。
  最初のマッチする位置は\Aと同様の文字列の先頭。

#### \b, \B, \<, \>
- 単語境界
#### (?=...), (?!...), (?<=...), (?<!...)
### コメントとモード修飾子
#### (?modifier)
- 
  (?i)や(?-i)など。
#### (?modifier:...)
- 
  (?i:...)など

#### (?#...), #...
- コメント
#### \Q...\E
- リテラルテキストの範囲
### グループ化、キャプチャ、条件分岐、制御
#### (...), \1, \2
#### (?:...)
#### (?<Name>...)
- 名前付きキャプチャ
#### (?>...)
- アトミックグループ
  閉じかっこを通り過ぎようとする時に保存ステートが捨てられる。
  ただし、捨てられるのはアトミックグループの中にいた間に作られたステートだけ。
  また、無駄な確認作業を除き、早期のマッチ不成功を導くために、アトミックグループを指定することも有用である。

#### ...|...|...
- 選択
#### (?if then | else)
- 条件分岐
#### *, +, ?, {num, num}
- 最大量指定子
#### *?, +?, ??, {num, num}?
- 最小量指定子

#### *+, ++, ?+, {num, num}+
- 絶対最大量指定子
  一度マッチした部分は決して手放さない。アトミックグループの略記法。
  例）「\w++」 ⇒ 「(?>\w+)」

## Library
- PCRE
- 鬼車
- GNU Regex

## History
### ed, grep, eprep, その他tools
### POSIX標準規格
- 
  1986年にBREとEREを制定した。
  ロケールの概念を取り入れた。

### Henry Spencerの正規表現パッケージ
- 
  C言語で書いた正規表現パッケージ。

### Perl
- 
  1987/12にPerl 1がリリースされる。
## Language
### Perl
#### 文字列
- 
  正規表現リテラルでの表現も可能だが、文字列として提供も可能。
  ただし効率は下がる。

### Java
- Class(Pattern, Matcher)
- Pattern.matches("\\s*", line)
- string.matches("\\s*", )

#### 文字列
- " ダブルクォートで囲む
- \ バックスラッシュはメタ文字
- \t タブ
- \n 改行
- \\ リテラルのバックスラッシュ

### .NET
- Class(Regex, Match)
- Regex.IsMatch(Line, "^\s*$")
  
#### VB.NET
##### 文字列
- " ダブルクォートで囲む。
- メタ文字はダブルクォートのみ。文字列内では""で"を表す。

#### C#
##### 文字列
- " ダブルクォートで囲む。""で"を表すのはVB.NET同様。
  "\\t\\x2A"と書く必要がある。
- @"" 逐語的文字列も可。バックスラッシュを認識しない。
  "\t\x2A"と書ける。

### PHP
- preg_match
  3種類のまったく無関係な正規表現エンジンが搭載されている。
  pgrep_matchが優れていると思われる

#### 文字列
- " ダブルクォートで囲む。
  \nなどの一般的なバックスラッシュシーケンス、変数の展開、{...}内のコードの実行結果を文字列に挿入するシーケンスをサポート。
  \tは認識するため\\tと書く必要があるが、\wは認識しないため\wと書けばよい。
- ' シングルクォート
  \'がシングルクォート、\\が1個のバックスラッシュとして扱われる。他の文字は逐語的にコピーされる。
  "\t\x2A"は"\t\x2A"となる。

### Python
- re.compile, search

#### 文字列
- '
- "
  'と"で囲んだ場合の違いはない。

- '''
- """
  トリプルクォートで囲んだ場合、エスケープされていない改行を入れられる。

- r'', r""
  先頭にrを付けると、"生文字列"として扱われる。
  全てのバックスラッシュが文字列内に残る。

### awk
- 置換
  sub(/mizpel/, "misspell")
  gsub(/mizpel/, "misspell")

### Tcl
- 置換
  regsub -all mizpel $var mispell newvar
  $varに含まれるある文字列"mizpel"を"mispell"に置換し、newvar変数に書き込む。

#### 文字列
- 文字列リテラルは存在差異内。
  バックスラッシュシーケンスは認識・変換されるが、認識されないバックスラッシュは単純に捨てられる。
  "で囲むこともできるが、単語に空白が含まれなければただの飾り。

### GNU Emacs
- 
  (re-search-forward "\\<\\([a-z)+\\)\\([\n \t]\\|<[^>]+>\\)+\\1\\>")
  括弧が多用される。

## Engine
### Type
- 
  |-----------+---------------------------------------------------------------------------------|
  | Type      | Program                                                                         |
  |-----------+---------------------------------------------------------------------------------|
  | DFA       | awk, egrep, flex, lex, MySQL, Procmail                                          |
  | 従来型NFA | GNU Emacs, Java, grep, less, more, .NET, PCRE, Perl, PHP, Python, Ruby, sed, vi |
  | POSIX NFA | mawk, Moritice KErn SystemsのUtility, GNU Emacs(必要な場合)                     |
  | Hybrid    | GNU awk, GNU grep/egrep, Tcl                                                    |
  |-----------+---------------------------------------------------------------------------------|

#### NFA
- Nondeterministic Finite Automaton 非決定性有限オートマトン
  正規表現主導型
  
- 
  部分式や要素を順番に見ていき、同等の可能性を持つ2つのオプションの中でどちらかを荒田無ければならなくなると、
  片方を選んだ上で、後で必要になったときにそこに戻れるように、もう片方も覚えておく。

- 選択
  従来型であれば、選択(...|...)は、欲張りでも控えめでもなく、「早い者勝ち」。
  DFAとPOSIX NFAは、欲張り、最も長いテキストがマッチする選択をする。

##### DFAとの機能の違い
- 括弧で囲まれた部分式のキャプチャ。
- 先後読みなどのゼロ幅マッチ
- 最小量指定子と早いもの勝ちの選択
- 絶対最大量指定子とアトミックグループ

##### バックトラック
- 
  量指定子のような"試行する""試行しない"という選択肢の場合、
  最大量指定子では"マッチを試行する"をまず選び、最小量指定子では"マッチを試行しない"をまず選ぶ。

- 
  局所的なマッチ不成功によってバックトラックを強いられた時に次に試すのは、最後に保存された選択肢。LIFOである。

###### 保存ステート
#### POSIX
- 
  最も左のもので最も長いもの、にマッチさせる、と規定されている。

- NFA
  NFAをPOSIXとして使うには、NFAがマッチした後停止せず、そのまますべてのオプションを走査し、
  その上で最長のものを選択する。
  
  処理効率が非常に悪くなる場合がある。
  
#### DFA
- Deterministic Finite Automaton 決定性有限オートマトン
  テキスト主導型
  すべての可能性のあるマッチを同時に管理する。
  
- 
  マッチを開始するまでに、時間とメモリを割いて分析し、マップを作る。正規表現のコンパイル、と呼ばれる。
  一度そのマップをつくった後は、それを参照し少ない労力で実行をする。

### Test
- 従来型NFAか否か
  - 最小量指定子がサポートしていれば、ほぼ従来型NFA。
    DFAは最小量指定子を実装できず、POSIX NFAでは無意味な機能。
  - 「nfa|nfa not」で"nfa not"をマッチさせた際、nfaしかマッチしなければ従来型NFA。
    nfa not全体がマッチする場合、DFAかPOSIX版。
- DFAかPOSIX NFAか
  - 「X(.+)+X」を"=XX==================="にマッチさせた場合に、長い時間かかっているならNFA。
    すぐ終わるなら、DFAか最適化されたNFA。

### マッチの基本原則
#### 最初にマッチしたものが優先される
#### 標準の量指定子は欲張りである
## Technique
- 任意の場所で本当にマッチしてよいものは何かに焦点を絞る
- 一般に、任意の深さを持つ入れ子構造に正規表現をマッチさせることはできない。
  - Perl, .NET, PCRE/PHPでは構文を導入したため、可能となっている。
- すべてをオプションとしてしまった場合、必ず行頭にマッチしてしまう。
  多くの場合、オプションでない箇所を用意する必要がある。
  - 例：-?[0-9]*\.?[0-9]*
- 不良なデータなど、正規表現をマッチさせたくない"特殊な"条件を検討することを忘れてはならない。
- ダブルクォートで囲まれた文字列にマッチさせる（ただしエスケープあり）
  - ex: "(\\.|[^\\"])*"

## Effiicency
## Memo
### Difference of BRE/ERE
- 
  - EREでは、BREより使えるメタ文字が増えている。(+, ?, |)
  - EREでは、括弧類のメタ文字がエスケープ不要。\( -> (, \{ -> {など
  - EREでは、後方参照が保障されていない。

### Mastering Regular Expressions
#### Meta Characters
##### Outside of Character Class
###### Match a character
####### .
- 
  任意の位置文字

####### [...]
- character class, 文字クラス
  
- 文字クラスは、否定形であっても、マッチすべき文字を要求する。
  ex) q[^u}に、Iraqはひっかからない。qのあとに文字がないため。
  
####### [^...]
- 否定文字クラス
  「...でないなにか」にマッチする、という意味。
  文字がない（空行など）ではマッチしない。
  
####### \char
- 
  メタ文字に\を前置することで、リテラルとして扱われるようにする。

###### quantifier 量指定子
####### ?
- 
  1回か0回
####### +
- 
  1回以上
####### *
- 
  0回以上
####### ...{min, max}
- interval quantifier
  繰り返し回数を指定する
###### Match positions
####### ^
- 行の先頭
####### $
- 行の末尾
####### \<
- 語の先頭（egrepの実装により有無あり）
####### \>
- 語の末尾（egrepの実装により有無あり）
###### etc
####### |
- or
####### (...)
- 
  まとめる役割。各種用途あり。
  1. 選択：「|」による選択の範囲に制限を設ける
  2. グループ化：複数の文字をまとめて、量指定子の対象とする
  3. キャプチャ：後方参照として使うために使う

- (?:...)
  キャプチャしない場合。
  

####### \1, \2
- 
  後方参照

##### Inside of Character Class
###### -
- A-Z
  範囲指定。
- [-
  [の直後に来た場合、解釈されず、単なる文字として認識される。

###### ^
- [^
  [の直後であれば否定。
- それ以外
  通常の文字。

### Caution
#### Character
- 
  Unicodeでは、結合文字であらわされる文字と、単体であらわされる文字で似たようなものがある。
  例：à（U+0061 + U+0300）とà（U+00E0）、I（U+0049、ローマ字のアイ）とΙ(U+0399、ギリシャ語のイオタ)など。
  これらをどのように扱うか、という点に気を付ける必要がある。

## Link
- [[http://qiita.com/richmikan@github/items/b6fb641e5b2b9af3522e][どのUNIXコマンドでも使える正規表現 - Qiita]]
- [[http://pubs.opengroup.org/onlinepubs/9699919799//basedefs/V1_chap09.html][9. Regular Expressions - The Open Group Base Specifications Issue 7]]
- [[http://www.grymoire.com/Unix/Regular.html][Regular Expressions - Grymoire Navigation]]
- [[http://doc.mas3.net/regexp/][手を動かしながら覚える正規表現＜基礎入門編＞]]
